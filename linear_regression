#for linear regression using the ggforestplot package from Nightingale Health Ltd.

library(ggforestplot)

#load your file which has all the NMR data and metadata like age, sex, BMI, group, etc.

#create a long file 

#load file
metabolite_file<- read.csv("my_NMR_file.csv")

#select metabolite cols only

biomarkers_for_reg <- colnames(metabolite_file)[3:175]

#log transform the raw data file 

metabolite_file_long <- metabolite_file %>%
  dplyr::select(tidyselect::all_of(biomarkers_for_reg), covariate1, covariate2, group) %>%        
  dplyr::mutate_at(
    .vars = dplyr::vars(tidyselect::all_of(biomarkers_for_reg),
    .funs = ~ .x %>% log1p() %>% as.numeric()
  ) %>%                                                                         #code below converts the file to a long format
  tidyr::gather(
    key = biomarkerid,
    value = biomarkervalue,
    tidyselect::all_of(biomarkers_for_reg)
  )

#use this long-format file for regression using the discovery regression function

#set predictor as factor
metabolite_file_long$group <- as.factor(metabolite_file_long$group)               #as group is categorical


linear_reg <- ggforestplot::discovery_regression(
  df_long = metabolite_file_long,
  model = "lm",
  formula = biomarkervalue ~ group+covariate1+covariate2,                                 #using group as predictor, controlling for other covariates (like age, sex, etc) 
  key = biomarkerid,
  predictor = "group"
)


sign_metabolites <- linear_reg %>%
  dplyr::mutate(
    pvalue_bh = p.adjust(pvalue, method = "BH")
  ) %>%
  dplyr::filter(as.numeric(pvalue_bh) < 0.05)

View(sign_metabolites)
