#for OPLSDA using the ropls package

library (ropls)

#log transform the original file 

#load your file which has all the NMR data and metadata like age, sex, BMI, group, etc.

#load file

metabolite_file<- read.csv("my_NMR_file.csv")

#select metabolite cols only

biomarkers_for_reg <- colnames(metabolite_file) [3:175]

#log transform the raw data file 

metabolite_file_log <- metabolite_file %>%
  dplyr::select(tidyselect::all_of(biomarkers_for_reg), covariate1, covariate2, group) %>%        
  dplyr::mutate_at(
    .vars = dplyr::vars(tidyselect::all_of(biomarkers_for_reg),
    .funs = ~ .x %>% log1p() %>% as.numeric()
  )

#regress with covariates included in the linear model apart from the predictor (group)

#select metabolite columns

metabolite_residual <- setdiff(colnames(metabolite_file_log), c("covariate1", "covariate2", "group"))

#generate residuals

residuals <- metabolite_file_log[, metabolite_residual]

#regress using the same covariates as in lm

for (metab in metabolite_residual) {
  model <- lm(as.formula(paste0(metab, " ~ covarite1 + covarite2")), data = metabolite_file_log)
  residuals[[metab]] <- resid(model)
}

#put back the same rownames
rownames(residuals) <- rownames(metabolite_file_log)


residuals$group <- c(rep("healthy", 78), rep("disease", nrow(residuals) - 78))

#use these to create a DataExperiment object for OPLSDA

opls <- DatasetExperiment(
  data = residuals[, 1:173],                                                         #all metabolite cols
  sample_meta = data.frame(class = residuals[, 174]),                                #the predictor (group)  
  variable_meta = data.frame(row.names = colnames(residuals[, 1:173]))               #metabolite names
)

#do pca

opls.pca<- opls(opls$data)

#set group as predictor (Y)

condition<- opls$sample_meta[, "class"]                                                #group

#plot
plot(opls.pca,
     typeVc = "x-score",
     parAsColFcVn = condition)

#do oplsda
results_oplsda<- opls(opls$data, condition,
                 predI = 1, orthoI = NA, permI = 500)                                   #run model 500 times

#check OPLSDA output, check Q2 values (<0.4 = not the best model, >0.4 = acceptable), and permuted R2 and Q2 values

#find the metabolites above VIP 1.0 that are more important, considering the multivariate results
